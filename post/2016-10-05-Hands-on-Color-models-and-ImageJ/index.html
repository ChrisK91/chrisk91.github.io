<!doctype html><html><head lang=en><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><link rel=stylesheet href=https://use.typekit.net/wcp3hcc.css><link href="/css/style.min.7fefe04f5558bed9f245a3975a2f09ecca5539b29f4a27c425f59babe1cffebd.css" rel=stylesheet><title>Hands on — Color models and ImageJ - ChrisK91.me</title></head><body class="bg-bluedark max-w-full lg:max-w-[80%] mx-auto"><div><div class="flex flex-col w-full px-4 py-4 mt-0 shadow-lg bg-bluemedium lg:mt-4 xl:mt-8"><div class="flex items-end justify-between font-sans text-6xl border-b md:text-9xl border-b-orange"><div><a href=/><span class="font-extrabold text-orange">ChrisK91</span><span class="font-light text-lightgreen">.me</span></a></div><div class="flex flex-col md:flex-row"><a href=https://twitter.com/ChrisK91 alt="Follow me on Twitter: @ChrisK91"><svg class="w-12 h-12 p-2 transition fill-lightyellow hover:fill-orange" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645.0 138.72-105.583 298.558-298.558 298.558-59.452.0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055.0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421.0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391.0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04.0-57.828 46.782-104.934 104.934-104.934 30.213.0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a><a href=https://med-mastodon.com/@chris alt="Follow me on Mastodon: @chris@med-mastodon.com"><svg class="w-12 h-12 p-2 transition fill-lightyellow hover:fill-orange" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48.0.0.0-63.72 28.5-63.72 125.7.0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54.0 01-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg></a></div></div></div><ul class="flex flex-row w-full mt-4 text-2xl font-bold shadow-lg bg-lightgreen justify-center space-x-4"><li><a href=/post/ class="hover:text-bluemedium transition hover:underline text-bluedark"><span>blog</span></a></li><li><a href=/pages/about/ class="hover:text-bluemedium transition hover:underline text-bluedark"><span>about me</span></a></li><li><a href=/post/2018-09-19-Basic-CSS-Template-for-Anki/ class="hover:text-bluemedium transition hover:underline text-bluedark"><span>Anki CSS Template</span></a></li><li><a href=/tools/correlation-shift.html class="hover:text-bluemedium transition hover:underline text-bluedark"><span>Correlation Shift</span></a></li><li><a href=https://chrisk91.me/ekgApp/ class="hover:text-bluemedium transition hover:underline text-bluedark"><span>EKG visualizer</span></a></li></ul><aside class="sticky right-0 top-0 invisible xl:visible float-right mt-12 mr-2 2xl:mr-28 2xl:mt-24 bg-white/20 backdrop-blur pl-1.5"><h5 class="font-bold text-bluedark text-lg 2xl:text-4xl 2xl:font-extrabold pt-3 pb-2">Outline</h5><ul class=toc><li><a href=#top-of-article>Back to top</a></li></ul><nav id=TableOfContents><ul><li><a href=#setup>Setup</a></li><li><a href=#splitting-the-image>Splitting the image</a><ul><li><a href=#identifying-the-channels-of-interest>Identifying the channels of interest</a></li><li><a href=#recombining-the-stack-and-hsv>Recombining the stack and HSV</a></li></ul></li><li><a href=#color-threshold>Color threshold</a></li><li><a href=#selecting-the-purple-cells-based-on-hsv>Selecting the purple cells based on HSV</a></li><li><a href=#selecting-the-purple-cells-based-on-rgb>Selecting the purple cells based on RGB</a></li><li><a href=#outlook>Outlook:</a></li><li><a href=#image-sources>Image sources</a></li></ul></nav></aside><div class="p-2 md:pt-16 xl:pt-32 md:pl-8 xl:pl-32 2xl:pl-48 mt-4 mb-8 bg-white shadow-lg md:p-8 prose-p:font-serif prose-code:bg-bluemedium prose-code:text-white prose-code:px-1 prose-code:py-1 prose-code:rounded prose-code:select-all prose-code:font-mono prose-code:font-light prose-code:text-sm"><div class="prose lg:prose-xl" id=content><h1 class="mb-0 lg:mb-1" id=top-of-article>Hands on — Color models and ImageJ</h1><div class=not-prose><ul class="flex p-4 gap-x-2"><li><a class="bg-bluedark hover:bg-bluemedium transition hover:underline px-2 py-1 text-white decoration-orange font-medium tracking-wide text-xs hover:shadow-sm uppercase" href=/tags/Color/ title="Browse tag: Color">#Color</a></li><li><a class="bg-bluedark hover:bg-bluemedium transition hover:underline px-2 py-1 text-white decoration-orange font-medium tracking-wide text-xs hover:shadow-sm uppercase" href=/tags/ImageJ/ title="Browse tag: ImageJ">#ImageJ</a></li></ul></div><small class="text-bluemedium text-sm font-bold font-sans">Posted on October 5, 2016 |
Reading time 8 minutes</small><br><div class="not-prose flex w-full border border-lightgreen bg-lightyellow shadow-lg mt-2"><div class="bg-lightgreen rotate-180 [writing-mode:_vertical-lr] p-2 font-extrabold text-bluedark text-lg uppercase tracking-wide">key points</div><div class="p-2 keypoints place-self-center"><ul><li>You will learn how the convert an image to RGB or HSV channels</li><li>You will get to know the color threshold tool in ImageJ</li></ul></div></div><h2 id=setup>Setup</h2><p>Now that we&rsquo;ve looked at <a href=https://chrisk91.me/post/2016-09-28-An-introduction-to-color/>color spaces and models</a> it&rsquo;s time to put that knowledge to use. I will be using <a href=http://fiji.sc/>Fiji</a> to illustrate these steps. We will use the image below (from Mary Ann Thompson) as an example. The original is available (in higher resolution) on <a href=https://commons.wikimedia.org/wiki/File:Chronic_lymphocytic_leukemia.jpg>Wikimedia Commons</a>. Just do a right click and select <em>copy</em> on the image below. You can then paste it in ImageJ via <em>Edit → Paste</em> (or <span class="font-sans bg-bluemedium px-2 py-1.5 border border-bluedark text-xs font-semibold rounded-md text-white whitespace-nowrap">Ctrl + V</span>).</p><p><em>Please note:</em> This image is in JPG format, which is lossy. Saving this image again and again (even with a quality of 100) will cause artifacts. These can even influence your analysis. It&rsquo;s best practice to use a lossless format (e.g. TIF) when storing your data. Also: never overwrite your original data! Always work on a copy.</p><div class="flex flex-col not-prose p-2 md:p-4 xl:p-6 md:shadow-lg bg-bluemedium/10 border border-bluemedium/20 xl:max-w-[80%] mx-auto"><img src=/images/color_models_blood/cll.jpg alt><p class="mt-2 text-base text-bluedark">We will use this image to put our knowledge of color models to use</p></div><h2 id=splitting-the-image>Splitting the image</h2><p>Let&rsquo;s assume that we are interested in the darker cells, and want to select them using a color threshold. So, let&rsquo;s start by <em>splitting up the picture into the RGB channels</em>. This can be done via <em>Image → Type → RGB Stack</em>. As the name implies, your image will be turned into stack composed of a slice for the red channel, one for the green channel and a third one for the blue channel &mdash; an RGB stack.</p><div class="flex flex-col not-prose p-2 md:p-4 xl:p-6 md:shadow-lg bg-bluemedium/10 border border-bluemedium/20 xl:max-w-[80%] mx-auto"><img src=/images/color_models_blood/screenshots/split_image.jpg alt><p class="mt-2 text-base text-bluedark">The label of the current slice (yellow) displays the channel that is currently displayed. You can navigate to the other slices with the scroll bar (blue)</p></div><h3 id=identifying-the-channels-of-interest>Identifying the channels of interest</h3><p>Now, lets think about what we are actually looking for here. We want information, that tells apart the originally purple cells from the rest of the image. So we check, if one (or more channels) depicts these cells very bright and the background very dark (or vice versa) &mdash; in other words: <em>we are interested in a slice with large contrast between our feature of interest and the remaining area of the image</em>. Which channels would you pick?</p><div class="not-prose grid grid-cols-2 gap-2 md:gap-4 xl:gap-6"><div class="flex flex-col p-2 md:shadow-lg bg-bluemedium/10 border border-bluemedium/20"><img src=/images/color_models_blood/cll.jpg alt><p class="mt-2 text-base text-bluedark">Original</p></div><div class="flex flex-col p-2 md:shadow-lg bg-bluemedium/10 border border-bluemedium/20"><img src=/images/color_models_blood/Red.jpg alt><p class="mt-2 text-base text-bluedark">Red channel</p></div><div class="flex flex-col p-2 md:shadow-lg bg-bluemedium/10 border border-bluemedium/20"><img src=/images/color_models_blood/Green.jpg alt><p class="mt-2 text-base text-bluedark">Green channel</p></div><div class="flex flex-col p-2 md:shadow-lg bg-bluemedium/10 border border-bluemedium/20"><img src=/images/color_models_blood/Blue.jpg alt><p class="mt-2 text-base text-bluedark">Blue channel</p></div></div><p>The red channel seems to display our cells really well, while the red blood cells remain more pale here. The green channel appears similar, although the erythrocytes appear darker here. The last channel &mdash; indicating the intensity of blue &mdash; displays our cells very bright; they almost fade into the white background. <em>Let&rsquo;s take a mental note: the feature we&rsquo;re interested in seems to stand out in the red and green channel.</em></p><h3 id=recombining-the-stack-and-hsv>Recombining the stack and HSV</h3><p>There are two options to change the stack back to the original image:</p><ul><li>We can recombine the RGB stack with <em>Image → Color → Stack to RGB</em> (this will create a new image, but we can close the old one)</li><li>We can simply change the type with <em>Image → Type → RGB Color</em></li></ul><p>Both options work just fine. We can then change the type to an HSV stack with <em>Image → Type → HSB Stack</em> (remember: sometimes the V for value is replaced with B for brightness). Now look again if our cells stand out in one channel.</p><div class="not-prose grid grid-cols-2 gap-2 md:gap-4 xl:gap-6"><div class="flex flex-col p-2 md:shadow-lg bg-bluemedium/10 border border-bluemedium/20"><img src=/images/color_models_blood/cll.jpg alt><p class="mt-2 text-base text-bluedark">Original</p></div><div class="flex flex-col p-2 md:shadow-lg bg-bluemedium/10 border border-bluemedium/20"><img src=/images/color_models_blood/Hue.jpg alt><p class="mt-2 text-base text-bluedark">Hue channel</p></div><div class="flex flex-col p-2 md:shadow-lg bg-bluemedium/10 border border-bluemedium/20"><img src=/images/color_models_blood/Saturation.jpg alt><p class="mt-2 text-base text-bluedark">Saturation channel</p></div><div class="flex flex-col p-2 md:shadow-lg bg-bluemedium/10 border border-bluemedium/20"><img src=/images/color_models_blood/Brightness.jpg alt><p class="mt-2 text-base text-bluedark">Value (= brightness) channel</p></div></div><p>The most promising one seems to be the saturation. <em>The pale red blood cells have a lower saturation than our deep purple cells.</em> Let&rsquo;s add this information to our mental note, and recombine our image via <em>Image → Type → RGB Color</em></p><h2 id=color-threshold>Color threshold</h2><p>In imaging, a threshold assigns every pixel one of two categories. With our cells these categories will be:</p><ul><li>Is a purple cell</li><li>Is not a purple cell</li></ul><p>Note that both categories complete each other &mdash; there is no third possibility or an uncertainty. Every pixel will either be of category one or two. Let&rsquo;s open up the color threshold menu with <em>Image → Adjust → Color threshold&mldr;</em></p><div class="flex flex-col not-prose p-2 md:p-4 xl:p-6 md:shadow-lg bg-bluemedium/10 border border-bluemedium/20 xl:max-w-[80%] mx-auto"><img src=/images/color_models_blood/screenshots/color_threshold.png alt><p class="mt-2 text-base text-bluedark">The color threshold window.</p></div><p><strong>General layout:</strong> You can notice that the window is split in several parts. The vast majority of space is occupied by settings corresponding to the &ldquo;parts&rdquo; of our color model. Since I&rsquo;ve selected &ldquo;HSB&rdquo; at the bottom (in the <em>Color space</em> setting), these &ldquo;parts&rdquo; are <em>hue</em>, <em>saturation</em> and <em>brightness</em>. You can switch to another model, e.g. <em>RGB</em> and see how the three controls will change to <em>red</em>, <em>green</em> and <em>blue</em>. But for now, we will leave <em>HSB</em> selected.</p><p><strong>Buttons:</strong> There are also several buttons. We are interested in the first three:</p><ul><li><em>Original</em> displays the original image</li><li><em>Filtered</em> creates a color coded version of your image. Everything that certain criteria &mdash; which we will talk about later &mdash; is indicated in red. Everything else is kept as is. You can change the color between <em>red</em> (default), <em>black</em> and <em>black and white</em>. The last will create a picture in which the &ldquo;selected&rdquo; signal is white and background is black.</li><li><em>Selection</em> creates a selection containing everything that &ldquo;passes&rdquo;</li></ul><p>There are also several other buttons. <em>Sample</em> will try to create a filter based on the current selection. <em>Stack</em> applies your settings to the remaining images, if you have a stack open. The last button (<em>Macro</em>) can create code used for automation. These buttons are not relevant for us in this example.</p><p><strong>Filters:</strong> The filters are made of histograms, a range selection (the two scroll bars) and a mysterious <em>Pass</em> check box. The histogram displays how many pixels have a certain hue, saturation or brightness. Since we have a lot of reddish cells, we can see a peak in the red area of the hue-histogram. With the scroll bars beneath the histogram, we can select a range. This will be indicated as a black rectangle on the histogram. Now, before we come to the <em>Pass</em> check box, we need to understand what this filter does.</p><p>Select 0 on the upper slider of each filter, and 255 on the lower slider. Make sure that <em>Pass</em> is checked:</p><div class="flex flex-col not-prose p-2 md:p-4 xl:p-6 md:shadow-lg bg-bluemedium/10 border border-bluemedium/20 xl:max-w-[80%] mx-auto"><img src=/images/color_models_blood/screenshots/sample_settings.png alt><p class="mt-2 text-base text-bluedark">Let's adjust our filter so that everything passes.</p></div><p>Now the complete picture is red. This is because we perform three checks:</p><ul><li>Is the hue between 0 and 255 (unfortunately our 360° are mapped to 255 values. This has technical reasons)?</li><li>Is the saturation between 0 and 255?</li><li>Is the brightness between 0 and 255?</li></ul><p>If everything can be answered with &ldquo;yes&rdquo;, our pixel fulfills our filtering condition and is colored as red.</p><p>Now <em>uncheck</em> the <em>Pass</em> on the <em>Hue</em> filter. This will negate our first question. Instead, our conditions are:</p><ul><li>Is the hue <strong>not</strong> between 0 and 255?</li><li>Is the saturation between 0 and 255?</li><li>Is the brightness between 0 and 255?</li></ul><p>And since no pixel satisfies these conditions, nothing is colored in red.</p><h2 id=selecting-the-purple-cells-based-on-hsv>Selecting the purple cells based on HSV</h2><p>No, let&rsquo;s take a look at our mental note. We determined that our cells were easy to recognize in the saturation channel. Adjust your filter so that every <em>hue</em> and every <em>brightness</em> passes. This can be accomplished by <em>either</em> selecting a range of 80 to 255 and the <em>pass</em> option <em>or</em> selecting the range 0 to 80 <em>without</em> the <em>pass</em> option:</p><div class="flex flex-col not-prose p-2 md:p-4 xl:p-6 md:shadow-lg bg-bluemedium/10 border border-bluemedium/20 xl:max-w-[80%] mx-auto"><img src=/images/color_models_blood/screenshots/purple_nuclei.png alt><p class="mt-2 text-base text-bluedark">These settings seem to select the purple nuclei rather well</p></div><p>You can see that the nuclei of the purple cells are selected. If you want to select the surrounding cytoplasm as well, we have open the saturation filter even more, so that the whole cell is selected, e.g. let a range from 11 to 255 pass. Don&rsquo;t be confused by the erythrocytes, we can exclude them based on hue. Adjust the <em>hue filter</em> to only let blue and violet colors pass. For example like this:</p><div class="flex flex-col not-prose p-2 md:p-4 xl:p-6 md:shadow-lg bg-bluemedium/10 border border-bluemedium/20 xl:max-w-[80%] mx-auto"><img src=/images/color_models_blood/screenshots/complete_purple.png alt><p class="mt-2 text-base text-bluedark">By opening the saturation filter even more (while constricting based on hue) we can select the complete purple cell</p></div><p>But unfortunately some parts of the erythrocytes are selected as well&mldr;</p><h2 id=selecting-the-purple-cells-based-on-rgb>Selecting the purple cells based on RGB</h2><p>You should now know how to use the color threshold window. So, try to create a threshold using the <em>RGB</em> option of the <em>color space</em> setting at the bottom of the window. I suggest opening up all filters and starting with something where every signal passes. Also try to remember: in which channel were the purple cells easy to identify?</p><p>I ended up with the settings below.</p><div class="flex flex-col not-prose p-2 md:p-4 xl:p-6 md:shadow-lg bg-bluemedium/10 border border-bluemedium/20 xl:max-w-[80%] mx-auto"><img src=/images/color_models_blood/screenshots/rgb_settings.png alt><p class="mt-2 text-base text-bluedark">Thresholding based on RGB</p></div><p>You can see that the upper left cell is really causing trouble, since it is so bright. The color of it&rsquo;s cytoplasm is very similar to the color of a bright erythrocyte. But as a start, we didn&rsquo;t do too bad.</p><h2 id=outlook>Outlook:</h2><p>We&rsquo;ve used the color models the see if we were able to create a threshold using the RGB and HSV color model. We had a look at all the channels to get an idea of possible threshold approaches. We determined which channels displayed the desired feature prominently, and used this knowledge to create settings to extract this feature.</p><p>The result is still not perfect. Depending on your settings we still would need to tidy up this selection. We have some &ldquo;false positives&rdquo; in our data, so we would still need to clean up the result of the threshold. But we have created a solid foundation for further steps. If you&rsquo;re looking for example to practice color thresholding here are some ideas:</p><ul><li>Take a picture of a rainbow and play around with the RGB and HSV models. Here you can also play with the <em>pass</em> option</li><li>Use the image of a flower field distinguish between grass and flowers</li><li>Try a sunset photo to select the sky and the ground</li><li>Use a fluorescent merge image and see, if you can select the original channels of this merge image.</li></ul><div class="flex flex-col not-prose p-2 md:p-4 xl:p-6 md:shadow-lg bg-bluemedium/10 border border-bluemedium/20 xl:max-w-[80%] mx-auto"><img src=/images/color_models_blood/outlook.png alt><p class="mt-2 text-base text-bluedark">ImageJ contains tools to clean our selection. We can also split the cells and measure them.</p></div><h2 id=image-sources>Image sources</h2><p>The original image of blood cells (by Mary Ann Thompson) can be found on <a href=https://commons.wikimedia.org/wiki/File:Chronic_lymphocytic_leukemia.jpg>Wikimedia Commons</a> and is licensed under the <a href=https://creativecommons.org/licenses/by-sa/3.0/deed.en>CC BY SA</a> license.</p></div></div><div class="p-2 mt-4 mb-8 bg-white shadow-lg md:p-8"><div class="prose lg:prose-xl mb-2" id=content><h1>Comments</h1></div><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//http-chrisk91-me.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=G-30MHG4HNXJ"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-30MHG4HNXJ",{anonymize_ip:!1})}</script></body></html>